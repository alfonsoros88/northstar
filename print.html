<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Northstar</title>
        
        <meta name="robots" content="noindex" />
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="favicon.svg">
        
        
        <link rel="shortcut icon" href="favicon.png">
        
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        
        <link rel="stylesheet" href="css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        

        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="client/client.html"><strong aria-hidden="true">1.</strong> Implementing a client</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="client/connect.html"><strong aria-hidden="true">1.1.</strong> Interacting with Northstar</a></li><li class="chapter-item expanded "><a href="client/repositories.html"><strong aria-hidden="true">1.2.</strong> Repositories</a></li><li class="chapter-item expanded "><a href="client/containers.html"><strong aria-hidden="true">1.3.</strong> Containers</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Northstar</h1>

                    <div class="right-buttons">
                        
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1><a class="header" href="#implementing-a-client" id="implementing-a-client">Implementing a client</a></h1>
<p>This tutorial demonstrates how to interact with <strong>Northstar</strong> using its <strong>REST
API</strong>.</p>
<p><strong>Northstar</strong> uses <strong>JSON</strong> to encode the messages shared with clients. This is
a common approach that facilitate clients to be implemented in any programming
language.  However, <strong>Northstar</strong> as a library, provides a convenient <code>Client</code>
type that can be used for a simpler client implementation using <strong>Rust</strong>.</p>
<p>For the purpose of being general, the snippets shown in this tutorial are
written in <strong>Python</strong> for its simplicity and easy translation to other
languages.</p>
<h1><a class="header" href="#interation-with-northstar" id="interation-with-northstar">Interation with Northstar</a></h1>
<p>Northstar interacts with clients through a <code>TCP</code> socket. The clients exchange
messages with Northstar in the form of requests and responses encoded in
<strong>JSON</strong>. These requests and responses are a direct serialization of the
structures defined in <code>api/model.rs</code>.</p>
<p>The first step is to establish a connection with Northstar using a socket.</p>
<pre><code class="language-python">import socket

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((&quot;localhost&quot;, 4200))
</code></pre>
<p>Northstar uses the port <code>4200</code> by default. Check the configuration (see
<code>northstar.toml</code>) for the port used by the target instance.</p>
<p>The messages sent between Northstar and the clients have two fields, <code>id</code> and
<code>payload</code>.  The <code>id</code> field is a generated <code>UUID</code> version 4 identifier used to
tag a message exchange.</p>
<pre><code class="language-json">{
    &quot;id&quot;: &quot;UUID&quot;,
    &quot;payload&quot;: {
        MESSAGE_TYPE: { ... }
    }
}
</code></pre>
<p>The <code>MESSAGE_TYPE</code> can be either <code>&quot;Request&quot;</code>, <code>&quot;Response&quot;</code>, or <code>&quot;Notification&quot;</code>.
Northstar should only send responses and notifications to clients.</p>
<h1><a class="header" href="#northstar-repositories" id="northstar-repositories">Northstar Repositories</a></h1>
<p>Repositories are used to group sets of containers. These are specified in
the Northstar configuration (see <code>northstar.toml</code>).</p>
<p>Containers can be added or removed from repositories at runtime by
<strong>installing</strong> and <strong>uninstalling</strong> them. Note that repositories will not allow
these actions if they are configured with the <code>writable</code> parameter set to
<code>false</code>.</p>
<p>Repositories specified in the configuration are accessed at the start of
Northstar. Currently it is not possible to add or remove repositories at
runtime.</p>
<p>If a repository specifies a signing key in the configuration, the content of its
containers is checked with their signature information. Otherwise, this step is
skipped. Notice that for the verification step, it is required that the
underlying system has <code>verity</code> support enabled. Containers installed at runtime
to repositories with a signing key, will be verified too.</p>
<p>Here is an example on how to request the repository configuration:</p>
<pre><code class="language-python"># API Request for repository information
request = {
    'id': str(uuid.uuid4()),
    'payload': {
        'Request': 'Repositories'
    }
}

# It is required for the API requests to be terminated with a new line'\n'
request = json.dumps(request) + '\n'

# send the request
s.send(bytes(request, 'utf-8'))

# receive the list of repositories
response = s.recv(8000)

# decode the response
response = json.loads(str(response, 'utf-8'))

# The response contains a list with the configured repositories
# Currently, only the filesystem path of every repository is provided
repositories = response['payload']['Response']['Repositories']
print(f'repositories: {repositories}')
</code></pre>
<h1><a class="header" href="#containers" id="containers">Containers</a></h1>
<h3><a class="header" href="#listing-containers" id="listing-containers">Listing containers</a></h3>
<p>In the smae way as <a href="client/repositories.html">repositories</a>, it is possible to request
the current state of the Northstar containers. Here is an example similar to the
one for repositories:</p>
<pre><code class="language-python"># The request looks like this:
request = {
    'id': str(uuid.uuid4()),
    'payload': {
        'Request': 'Containers'
    }
}

# notice the terminating '\n'
request = json.dumps(request) + '\n'

# send request
s.send(bytes(request, 'utf-8'))

# receive the list of containers
response = s.recv(8000)
response = json.loads(str(response, 'utf-8'))

# The response is a list of containers.
# Each of these containers will come with the following fields:
#   - manifest
#   - process
#   - repository
print(response)
</code></pre>
<p>The response is quite lengthy and more complex to that of repositories. This
time, we receive a list of objects corresponding to each container. Each
of them provides information about the container's manifest, the repository
where it is installed and possibly information about the system process if it is
currently on execution.</p>
<p>Here is an example on how to get a list with names of the available containers:</p>
<pre><code class="language-python">names = []
for container in response['payload']['Response']['Containers']:
    names.append(c['manifest']['name'])

print(f'containers: {names}')
</code></pre>
<h3><a class="header" href="#starting-containers-and-notifications" id="starting-containers-and-notifications">Starting containers and notifications</a></h3>
<p>Northstar has a notification system where messages are sent to the clients with
information about events such as:</p>
<ul>
<li>Applications starting</li>
<li>Applications stopping</li>
<li>Applications installed</li>
<li>Applications uninstalled</li>
<li>Exit status of applications</li>
<li>Shutdown of the runtime</li>
<li>Applications running out of memory</li>
</ul>
<p>In the following snippet, a request is sent to start the <code>memeater</code> example
container. After the container is started, we will receive 2 notifications, one
to signal the start of the application and eventually a second one that signals
the termination of the application for consuming all the memory.</p>
<pre><code class="language-python"># start memeater container
request = {
    'id': str(uuid.uuid4()),
    'payload': {
        'Request': {
            'Start': &quot;memeater&quot;
        }
    }
}

# send the request
request = json.dumps(request) + '\n'
s.send(bytes(request, 'utf-8'))

# Receive the ok response to the request
response = s.recv(8000)
print(json.loads(str(response, 'utf-8')))

# Receive the first notification for the start of the container
data = s.recv(8000)
response = json.loads(str(data, 'utf-8'))
print(f'container started notification: {response}')

# Receive the notification for the out of memory
data = s.recv(8000)
response = json.loads(str(data, 'utf-8'))
print(f'out of memory: {response}')
</code></pre>
<h3><a class="header" href="#stopping-containers" id="stopping-containers">Stopping containers</a></h3>
<p>Stopping containers is very similar to starting them. In the following snippet
we start and subsequently stop the <code>hello</code> example container.</p>
<pre><code class="language-python"># Start hello container
request = {
    'id': str(uuid.uuid4()),
    'payload': {
        'Request': {
            'Start': &quot;hello&quot;
        }
    }
}

# Send the request
request = json.dumps(request) + '\n'
s.send(bytes(request, 'utf-8'))

# get ok response
response = s.recv(8000)
print(json.loads(str(response, 'utf-8')))

# get application started notification
response = s.recv(8000)
print(json.loads(str(response, 'utf-8')))

# Stop hello container
request = {
    'id': str(uuid.uuid4()),
    'payload': {
        'Request': {
            'Stop': &quot;hello&quot;
        }
    }
}

# Send the request
request = json.dumps(request) + '\n'
s.send(bytes(request, 'utf-8'))

# Get ok response
response = s.recv(8000)
print(json.loads(str(response, 'utf-8')))

# Get notification for the stopped container
response = s.recv(8000)
print(json.loads(str(response, 'utf-8')))
</code></pre>
<h3><a class="header" href="#installing-and-uninstalling-containers" id="installing-and-uninstalling-containers">Installing and uninstalling containers</a></h3>
<p>Installing containers is a bit trickier. First a request to install a new
container is sent with the target repository and the size of the container <code>npk</code>
file in bytes. Then the file is directly copied into the socket. If successful,
an <code>Ok</code> response will be received and a notification of the newly installed
container.</p>
<p>For the following snippet, we can create a dummy container called <code>foo</code>. First,
we create a directory layout for he container that looks like this:</p>
<pre><code>foo
├── manifest.yaml
└── root
    └── foo
</code></pre>
<p>The file <code>foo</code> inside the <code>root</code> is just a &quot;hello world&quot; binary compiled for the
host architecture but any other file works for this example. The content for the
<code>manifest.yaml</code> is the following:</p>
<pre><code class="language-yaml">name: foo
version: 0.0.1
init: /foo
mounts:
    /lib:
        host: /lib
    /lib64:
        host: /lib64
</code></pre>
<p>Finally, we use <code>sextant</code> to pack the container into a <code>npk</code> file.</p>
<pre><code class="language-sh">sextant pack --dir foo --out . --key examples/keys/northstar.key
</code></pre>
<p>This will produce a file named <code>foo-0.0.1.npk</code> in the current directory. Now we
can install and uninstall the container in Northstar as follows:</p>
<pre><code class="language-python">import os

npk = &quot;foo-0.0.1.npk&quot;
npk_size = os.path.getsize(npk)

# Request to install the container in the &quot;default&quot; repository
request = {
    'id': str(uuid.uuid4()),
    'payload': {
        'Request': {
            'Install': [&quot;default&quot;, npk_size]
        }
    }
}

# send the request
request = json.dumps(request) + '\n'
s.send(bytes(request, 'utf-8'))

# Now we simply copy the file to the socket
with open(npk, 'rb') as f:
    chunk = f.read(4096)
    while chunk:
        s.send(chunk)
        chunk = f.read(4096)

# Receive an ok response
response = s.recv(8000)
print(json.loads(str(response, 'utf-8')))

# Get application installed notification
response = s.recv(8000)
print(json.loads(str(response, 'utf-8')))

# Uninstall the container
request = {
    'id': str(uuid.uuid4()),
    'payload': {
        'Request': {
            'Uninstall': [&quot;foo&quot;, &quot;0.0.1&quot;]
        }
    }
}

# send the request
request = json.dumps(request) + '\n'
s.send(bytes(request, 'utf-8'))

# Receive an ok response
response = s.recv(8000)
print(json.loads(str(response, 'utf-8')))

# Get application uninstalled notification
response = s.recv(8000)
print(json.loads(str(response, 'utf-8')))

</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        

                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                

                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        

        
        
        <script type="text/javascript">
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>
        
        

    </body>
</html>
